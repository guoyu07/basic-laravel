machine:
  pre:
    - sudo apt-get update; USE_PRECOMPILE=true sudo -E circleci-install php 7.1.3
  timezone:
    Asia/Tokyo
  php:
    version: 7.1.3
  # environment:
  #   DB_CONNECTION: circle_test
  #   APP_ENV: testing
  # services:
  #   - mysql
  # database:
  #   override:
  #     - "php artisan migrate"
  #     - "php artisan db:seed"


dependencies:
  pre:
    # - composer config -g github-oauth.github.com $GITHUB_OAUTH_TOKEN
    - sudo mkdir -p /home/basic-laravel/storage/{app,framework,logs}
    - sudo mkdir -p /home/basic-laravel/storage/framework/{cache,sessions,views}
    - sudo chmod 777 -R /home/basic-laravel/storage
  override:
    - composer install --prefer-dist --no-interaction
  cache_directories:
    - ~/.composer/cache

test:
  pre:
    - "./vendor/laravel/dusk/bin/chromedriver-linux":
        background: true
    - cp .env.ci .env
    - php artisan config:cache
    - php artisan key:generate
    - php artisan config:cache
    - "php artisan serve":
        background: true
  override:
    # - php security-checker.phar security:check
    #- php artisan code-sniffer
    - php artisan dusk
    - vendor/bin/phpunit -d memory_limit=512M
    - php vendor/bin/phpcs routes/
    - php vendor/bin/phpcs app/
    - php vendor/bin/phpcs config/
